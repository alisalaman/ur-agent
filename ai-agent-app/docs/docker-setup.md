# Docker Setup Guide

This guide explains how to run the AI Agent application using Docker for reproducible behavior across environments.

## Overview

The application includes comprehensive Docker support with:
- Multi-stage Dockerfile for optimized builds
- Docker Compose configurations for different environments
- Development and production configurations
- Health checks and proper dependency management
- Security best practices

## Quick Start

### Prerequisites

- Docker Engine 20.10+
- Docker Compose 2.0+
- At least 2GB RAM available for containers

### 1. Clone and Setup

```bash
git clone <repository-url>
cd ai-agent-app
```

### 2. Environment Configuration

#### For Local Development
Copy the Docker environment template:

```bash
cp env.docker .env
```

Edit `.env` with your specific configuration:

```bash
# Required: Set your secret key
SECURITY_SECRET_KEY=your-super-secret-key-change-this

# Optional: Set your LLM API keys
OPENAI_API_KEY=your-openai-key
ANTHROPIC_API_KEY=your-anthropic-key
GOOGLE_API_KEY=your-google-key
```

#### For Production (Render)
The production configuration expects all environment variables to be set externally. See `env.production` for the complete list of required variables.

**Key differences for production:**
- All database and Redis credentials come from external services
- Security keys are generated by the hosting platform
- CORS origins should point to your actual frontend domain
- Debug mode is disabled by default

### 3. Start the Application

#### Production Mode
```bash
# Start all services (app + database + redis)
docker-compose up -d

# View logs
docker-compose logs -f ai-agent

# Check service status
docker-compose ps
```

#### Development Mode
```bash
# Start with hot reloading and development tools
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# View logs
docker-compose logs -f ai-agent
```

### 4. Access the Application

- **API**: http://localhost:8000
- **API Documentation**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/health
- **Redis Commander**: http://localhost:8081 (if using tools profile)
- **pgAdmin**: http://localhost:8080 (if using tools profile)

## Docker Configuration

### Multi-Stage Dockerfile

The `Dockerfile` includes three stages:

1. **Base**: Common dependencies and setup
2. **Development**: Includes dev tools and hot reloading
3. **Production**: Optimized for production deployment

### Docker Compose Files

#### `docker-compose.yml` (Production)
- Main application service
- PostgreSQL with pgvector
- Redis for caching
- Production-optimized settings
- Health checks and restart policies

#### `docker-compose.dev.yml` (Development)
- Development-specific overrides
- Hot reloading with volume mounts
- Additional development tools
- More permissive CORS settings

## Service Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   AI Agent      │    │   PostgreSQL    │    │     Redis       │
│   (Port 8000)   │◄──►│   (Port 5432)   │    │   (Port 6379)   │
│                 │    │   + pgvector    │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Environment Variables

### Required Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SECURITY_SECRET_KEY` | JWT signing key | **Must be set** |
| `DATABASE_HOST` | PostgreSQL host | `postgres` |
| `DATABASE_PORT` | PostgreSQL port | `5432` |
| `DATABASE_NAME` | Database name | `ai_agent` |
| `DATABASE_USER` | Database user | `postgres` |
| `DATABASE_PASSWORD` | Database password | `password` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `ENVIRONMENT` | Environment mode | `production` |
| `PORT` | Application port | `8000` |
| `HOST` | Application host | `0.0.0.0` |
| `CORS_ORIGINS` | Allowed CORS origins | `http://localhost:3000,http://localhost:8080` |
| `USE_DATABASE` | Enable database | `true` |
| `USE_REDIS` | Enable Redis | `true` |
| `ENABLE_WEBSOCKETS` | Enable WebSocket support | `true` |

### LLM Provider Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `OPENAI_API_KEY` | OpenAI API key | - |
| `ANTHROPIC_API_KEY` | Anthropic API key | - |
| `GOOGLE_API_KEY` | Google API key | - |
| `LM_STUDIO_BASE_URL` | LM Studio URL | `http://localhost:1234` |
| `LM_STUDIO_API_KEY` | LM Studio API key | `lm-studio` |
| `LM_STUDIO_MODEL` | LM Studio model | - |

## Development Workflow

### Running Tests

```bash
# Run all tests
docker-compose -f docker-compose.dev.yml --profile test run --rm ai-agent-test

# Run specific test file
docker-compose -f docker-compose.dev.yml --profile test run --rm ai-agent-test pytest tests/unit/test_llm_factory.py -v

# Run with coverage
docker-compose -f docker-compose.dev.yml --profile test run --rm ai-agent-test pytest --cov=src/ai_agent --cov-report=html
```

### Code Quality

```bash
# Lint code
docker-compose -f docker-compose.dev.yml --profile lint run --rm ai-agent-lint

# Format code
docker-compose -f docker-compose.dev.yml --profile format run --rm ai-agent-format
```

### Database Operations

```bash
# Run migrations
docker-compose exec ai-agent uv run python scripts/migrate_database.py

# Access database shell
docker-compose exec postgres psql -U postgres -d ai_agent

# Reset database
docker-compose down -v
docker-compose up -d
```

## Production Deployment

### 1. Environment Setup

For production deployment on Render, you don't need a `.env` file. Instead, set all environment variables in the Render dashboard.

**Required Environment Variables:**
```bash
# Application
ENVIRONMENT=production
HOST=0.0.0.0
PORT=10000
APP_NAME=ai-agent-app
DEBUG=false
LOG_LEVEL=info

# Security (REQUIRED)
SECURITY_SECRET_KEY=your-super-secure-production-key

# Database (from Render database service)
DATABASE_HOST=from-service
DATABASE_PORT=from-service
DATABASE_NAME=ai_agent
DATABASE_USER=from-service
DATABASE_PASSWORD=from-service

# Redis (from Render Redis service)
REDIS_HOST=from-service
REDIS_PORT=from-service
REDIS_DB=0

# CORS (your frontend domain)
CORS_ORIGINS=https://yourdomain.com
FRONTEND_URL=https://yourdomain.com

# Feature Flags
USE_DATABASE=true
USE_REDIS=true
ENABLE_WEBSOCKETS=true

# LLM API Keys
OPENAI_API_KEY=your-production-openai-key
ANTHROPIC_API_KEY=your-production-anthropic-key
GOOGLE_API_KEY=your-production-google-key
```

**Note:** In Render, database and Redis credentials are automatically provided by the service connections defined in `render.yaml`.

### 2. Deploy with Docker Compose

```bash
# Start production services
docker-compose up -d

# Scale the application (if needed)
docker-compose up -d --scale ai-agent=3
```

### 3. Monitoring

```bash
# View logs
docker-compose logs -f ai-agent

# Check health
curl http://localhost:8000/health

# Monitor resource usage
docker stats
```

## Troubleshooting

### Common Issues

#### 1. Port Already in Use
```bash
# Check what's using the port
lsof -i :8000

# Use different port
PORT=8001 docker-compose up -d
```

#### 2. Database Connection Issues
```bash
# Check database logs
docker-compose logs postgres

# Test database connection
docker-compose exec ai-agent uv run python -c "
import asyncio
import asyncpg
async def test():
    conn = await asyncpg.connect('postgresql://postgres:password@postgres:5432/ai_agent')
    print('Database connected!')
    await conn.close()
asyncio.run(test())
"
```

#### 3. Memory Issues
```bash
# Check container memory usage
docker stats

# Increase Docker memory limit in Docker Desktop settings
```

#### 4. Build Issues
```bash
# Clean build
docker-compose build --no-cache

# Remove unused images
docker system prune -a
```

### Debug Mode

Enable debug logging:

```bash
# Set debug environment
echo "DEBUG=true" >> .env
echo "LOG_LEVEL=debug" >> .env

# Restart services
docker-compose restart ai-agent
```

## Security Considerations

### Production Security

1. **Change default passwords**: Update database and Redis passwords
2. **Use secrets management**: Store API keys in Docker secrets or external vaults
3. **Restrict CORS**: Only allow your frontend domains
4. **Use HTTPS**: Always use HTTPS in production
5. **Regular updates**: Keep base images updated

### Example Production Security Setup

```bash
# Use Docker secrets for sensitive data
echo "your-secure-password" | docker secret create db_password -
echo "your-secure-secret-key" | docker secret create jwt_secret -

# Update docker-compose.yml to use secrets
# (Add secrets configuration to postgres and ai-agent services)
```

## Performance Optimization

### Resource Limits

Add resource limits to `docker-compose.yml`:

```yaml
services:
  ai-agent:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
```

### Caching

Enable Redis caching:

```bash
# Ensure Redis is enabled
USE_REDIS=true

# Check Redis status
docker-compose exec redis redis-cli ping
```

## Backup and Recovery

### Database Backup

```bash
# Create backup
docker-compose exec postgres pg_dump -U postgres ai_agent > backup.sql

# Restore backup
docker-compose exec -T postgres psql -U postgres ai_agent < backup.sql
```

### Volume Backup

```bash
# Backup volumes
docker run --rm -v ai-agent-app_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres_backup.tar.gz -C /data .
```

## Support

For issues and questions:

1. Check the logs: `docker-compose logs -f ai-agent`
2. Verify environment variables: `docker-compose exec ai-agent env`
3. Test connectivity: `docker-compose exec ai-agent curl localhost:8000/health`
4. Check GitHub issues or create a new one

## Next Steps

- [Development Setup Guide](development/setup-guide.md)
- [API Documentation](api/README.md)
- [Deployment Guide](deployment/docker-setup.md)
